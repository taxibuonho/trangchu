<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taxi Meter V6 - GPS Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; }
        .digital { font-family: 'Orbitron', sans-serif; }
        .status-box { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
        #error-log { color: #ff4444; font-size: 10px; font-family: monospace; }
        .big-btn { transition: all 0.2s; -webkit-tap-highlight-color: transparent; }
        .big-btn:active { transform: scale(0.95); opacity: 0.8; }
    </style>
</head>
<body>

    <!-- MÀN HÌNH KHỞI ĐỘNG CƯỠNG BỨC -->
    <div id="setup-screen" class="fixed inset-0 z-[9999] bg-black flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-6 p-5 bg-yellow-500 rounded-full shadow-[0_0_50px_rgba(234,179,8,0.2)]">
            <svg class="w-12 h-12 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
        </div>
        <h1 class="text-3xl font-black italic mb-2">GPS ACTIVATOR</h1>
        <p class="text-zinc-400 text-sm mb-8">Vui lòng bấm nút bên dưới để yêu cầu quyền truy cập GPS từ trình duyệt.</p>
        
        <button onclick="forceStartGPS()" class="w-full max-w-xs bg-yellow-500 text-black font-black py-5 rounded-2xl text-lg shadow-xl big-btn">
            BẬT ĐỊNH VỊ NGAY
        </button>

        <div id="status-info" class="mt-8 w-full max-w-xs p-4 rounded-xl status-box text-left">
            <p class="text-[10px] font-bold text-zinc-500 uppercase mb-2">Trạng thái hệ thống:</p>
            <div id="error-log">Đang chờ tương tác...</div>
        </div>
    </div>

    <!-- GIAO DIỆN CHÍNH -->
    <div id="main-app" class="hidden h-screen flex flex-col p-4 pb-24">
        <header class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-black italic text-yellow-500">TAXI<span class="text-white">METER</span></h2>
            <div class="px-3 py-1 bg-green-500/10 border border-green-500/20 rounded-full flex items-center gap-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-[9px] font-black uppercase text-green-500">GPS Active</span>
            </div>
        </header>

        <div class="flex-1 flex flex-col justify-center">
            <div class="text-center mb-10">
                <p class="text-[10px] font-black text-zinc-500 uppercase tracking-[0.4em] mb-4">Tổng tiền (VNĐ)</p>
                <div id="fare-display" class="digital text-7xl font-black text-yellow-500 drop-shadow-[0_0_30px_rgba(234,179,8,0.3)]">0</div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="p-6 rounded-[2rem] status-box text-center">
                    <p class="text-[10px] font-black text-zinc-500 uppercase">Khoảng cách</p>
                    <div id="dist-display" class="digital text-3xl font-bold mt-1">0.00</div>
                    <p class="text-[10px] font-bold text-zinc-600 uppercase">Km</p>
                </div>
                <div class="p-6 rounded-[2rem] status-box text-center">
                    <p class="text-[10px] font-black text-zinc-500 uppercase">Tốc độ</p>
                    <div id="speed-display" class="digital text-3xl font-bold mt-1">0</div>
                    <p class="text-[10px] font-bold text-zinc-600 uppercase">Km/h</p>
                </div>
            </div>
        </div>

        <button id="action-btn" onclick="toggleTrip()" class="w-full bg-green-600 py-6 rounded-[2rem] font-black text-xl uppercase italic shadow-2xl big-btn">
            Bắt đầu đi
        </button>
    </div>

    <script>
        // Cấu hình cứng để test
        const price = { open: 12000, km: 15000, limit: 0.5 };
        
        let isRunning = false;
        let watchId = null;
        let totalDist = 0;
        let lastCoord = null;
        let currentFare = 0;

        const log = (msg) => {
            document.getElementById('error-log').innerHTML += `> ${msg}<br>`;
        };

        function forceStartGPS() {
            log("Đang yêu cầu quyền...");
            
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    log("Thành công! Đang vào ứng dụng...");
                    setTimeout(() => {
                        document.getElementById('setup-screen').style.display = 'none';
                        document.getElementById('main-app').style.display = 'flex';
                    }, 500);
                },
                (err) => {
                    if (err.code === 1) {
                        log("LỖI: Bạn đã từ chối quyền GPS.");
                        log("Vui lòng vào cài đặt trình duyệt để 'Cho phép lại'.");
                    } else if (err.code === 2) {
                        log("LỖI: Không thể xác định vị trí (Mất sóng).");
                    } else if (err.code === 3) {
                        log("LỖI: Hết thời gian chờ (Timeout).");
                    } else {
                        log("LỖI KHÔNG XÁC ĐỊNH: " + err.message);
                    }
                    if (window.location.protocol !== 'https:') {
                        log("<br>CẢNH BÁO: Bạn đang chạy web không có HTTPS. GPS sẽ không hoạt động.");
                    }
                },
                options
            );
        }

        function calculate(km) {
            if (km <= price.limit) return price.open;
            return price.open + (km - price.limit) * price.km;
        }

        function haversine(p1, p2) {
            const R = 6371;
            const dLat = (p2.lat - p1.lat) * Math.PI / 180;
            const dLon = (p2.lng - p1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function toggleTrip() {
            const btn = document.getElementById('action-btn');
            if (!isRunning) {
                // Bắt đầu
                isRunning = true;
                totalDist = 0;
                currentFare = price.open;
                lastCoord = null;
                btn.innerText = "Dừng lại";
                btn.classList.replace('bg-green-600', 'bg-red-600');

                watchId = navigator.geolocation.watchPosition((pos) => {
                    const { latitude: lat, longitude: lng, speed } = pos.coords;
                    document.getElementById('speed-display').innerText = speed ? Math.round(speed * 3.6) : 0;

                    if (lastCoord) {
                        const d = haversine(lastCoord, {lat, lng});
                        if (d > 0.003) { // 3 mét lọc nhiễu
                            totalDist += d;
                            currentFare = calculate(totalDist);
                            document.getElementById('dist-display').innerText = totalDist.toFixed(2);
                            document.getElementById('fare-display').innerText = Math.round(currentFare).toLocaleString('vi-VN');
                        }
                    }
                    lastCoord = {lat, lng};
                }, (err) => {
                    console.error(err);
                }, { enableHighAccuracy: true });

            } else {
                // Dừng
                navigator.geolocation.clearWatch(watchId);
                isRunning = false;
                btn.innerText = "Bắt đầu đi";
                btn.classList.replace('bg-red-600', 'bg-green-600');
                alert(`Chuyến đi kết thúc!\nQuãng đường: ${totalDist.toFixed(2)} km\nTổng tiền: ${Math.round(currentFare).toLocaleString('vi-VN')} VNĐ`);
            }
        }
    </script>
</body>
</html>

